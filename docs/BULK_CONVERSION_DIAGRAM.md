# ๐ Diagrama: Proceso de Conversiรณn a Granel

## ๐ Flujo Visual del Proceso

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    INVENTARIO INICIAL                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                  โ
โ  Producto: Arroz Diana - Paquete x 500g                        โ
โ  Stock Empaquetado: 10 paquetes                                 โ
โ  Stock a Granel: 0g                                             โ
โ                                                                  โ
โ  ๐ฆ ๐ฆ ๐ฆ ๐ฆ ๐ฆ ๐ฆ ๐ฆ ๐ฆ ๐ฆ ๐ฆ                                   โ
โ  (10 paquetes cerrados)                                         โ
โ                                                                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
                            โ Usuario hace clic en
                            โ "Abrir para Granel"
                            โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                   MODAL DE CONVERSIรN                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                  โ
โ  ๐ฆโก๏ธ๐พ Abrir Bulto para Granel                                 โ
โ                                                                  โ
โ  Producto: Arroz Diana                                          โ
โ  Presentaciรณn: Paquete x 500g                                   โ
โ  Paquetes disponibles: 10                                       โ
โ                                                                  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ              โ
โ  โ Presentaciรณn Granel: [Granel (gramos)    โผ] โ              โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ              โ
โ                                                                  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ              โ
โ  โ Cantidad en Paquete: [500                  ] โ              โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ              โ
โ                                                                  โ
โ  [Cancelar]  [Abrir Bulto]                                     โ
โ                                                                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
                            โ Usuario confirma
                            โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ              REQUEST AL BACKEND                                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                  โ
โ  POST /products/open-bulk/                                      โ
โ                                                                  โ
โ  {                                                              โ
โ    "source_lot_detail_id": "uuid-lote",                        โ
โ    "target_presentation_id": "uuid-granel",                    โ
โ    "quantity": 500                                             โ
โ  }                                                              โ
โ                                                                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
                            โ Backend procesa
                            โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ              OPERACIONES EN BASE DE DATOS                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                  โ
โ  1๏ธโฃ  UPDATE lot_detail                                         โ
โ      SET quantity_available = quantity_available - 1            โ
โ      WHERE id = source_lot_detail_id                            โ
โ                                                                  โ
โ      (10 paquetes โ 9 paquetes)                                 โ
โ                                                                  โ
โ  2๏ธโฃ  INSERT INTO bulk_conversion                               โ
โ      (source_lot_detail_id, target_presentation_id,             โ
โ       converted_quantity, remaining_bulk, status)               โ
โ      VALUES (uuid, uuid, 500, 500, 'ACTIVE')                    โ
โ                                                                  โ
โ      (Se crea registro de 500g a granel)                        โ
โ                                                                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
                            โ Backend responde
                            โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                   RESPUESTA EXITOSA                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                  โ
โ  {                                                              โ
โ    "message": "Bulto abierto exitosamente",                    โ
โ    "bulk_conversion_id": "uuid-conversion",                    โ
โ    "converted_quantity": 500,                                  โ
โ    "remaining_bulk": 500,                                      โ
โ    "status": "ACTIVE"                                          โ
โ  }                                                              โ
โ                                                                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
                            โ Frontend actualiza
                            โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                 INVENTARIO ACTUALIZADO                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                  โ
โ  Producto: Arroz Diana - Paquete x 500g                        โ
โ  Stock Empaquetado: 9 paquetes                                  โ
โ  Stock a Granel: 500g disponibles                               โ
โ                                                                  โ
โ  ๐ฆ ๐ฆ ๐ฆ ๐ฆ ๐ฆ ๐ฆ ๐ฆ ๐ฆ ๐ฆ  ๐พ                                  โ
โ  (9 paquetes cerrados)      (500g sueltos)                     โ
โ                                                                  โ
โ  โ Ahora se puede vender:                                      โ
โ     - Por paquetes completos (500g)                             โ
โ     - A granel (100g, 250g, etc.)                               โ
โ                                                                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ Ciclo de Vida de una Conversiรณn

```
โโโโโโโโโโโโโโโโ
โ   CREACIรN   โ  โ POST /products/open-bulk/
โโโโโโโโฌโโโโโโโโ
       โ
       โ status: "ACTIVE"
       โ remaining_bulk: 500
       โ
       โผ
โโโโโโโโโโโโโโโโ
โ   ACTIVA     โ  โ Se puede vender a granel
โโโโโโโโฌโโโโโโโโ    GET /products/bulk-stock/
       โ
       โ Cliente compra 100g
       โ remaining_bulk: 400
       โ
       โผ
โโโโโโโโโโโโโโโโ
โ   ACTIVA     โ  โ Aรบn hay stock disponible
โโโโโโโโฌโโโโโโโโ    remaining_bulk: 400
       โ
       โ Cliente compra 400g
       โ remaining_bulk: 0
       โ
       โผ
โโโโโโโโโโโโโโโโ
โ  COMPLETADA  โ  โ Se vendiรณ todo el granel
โโโโโโโโโโโโโโโโ    status: "COMPLETED"
```

---

## ๐ Diagrama de Estados

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    BULK CONVERSION                           โ
โ                                                              โ
โ  โโโโโโโโโโโโโโ   Vender    โโโโโโโโโโโโโโ   Vender todo  โ
โ  โ   ACTIVE   โโโโโโโโโโโโ  โ   ACTIVE   โโโโโโโโโโโโโโโโ โ
โ  โ (500g)     โ   100g      โ (400g)     โ                โ
โ  โโโโโโโโโโโโโโ             โโโโโโโโโโโโโโ                โ
โ       โ                            โ                        โ
โ       โ                            โ                        โ
โ       โผ                            โผ                        โ
โ  remaining_bulk                remaining_bulk              โ
โ  disminuye                     llega a 0                   โ
โ                                     โ                        โ
โ                                     โผ                        โ
โ                            โโโโโโโโโโโโโโโโ                โ
โ                            โ  COMPLETED   โ                โ
โ                            โ   (0g)       โ                โ
โ                            โโโโโโโโโโโโโโโโ                โ
โ                                                              โ
โ  Opcional: Cancelar conversiรณn                              โ
โ  โโโโโโโโโโโโโโ   Cancelar  โโโโโโโโโโโโโโโโ              โ
โ  โ   ACTIVE   โโโโโโโโโโโโโ โ  CANCELLED   โ              โ
โ  โ (cualquier)โ             โ              โ              โ
โ  โโโโโโโโโโโโโโ             โโโโโโโโโโโโโโโโ              โ
โ                                                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ Sistema FIFO (First In, First Out)

```
Escenario: Se abren 3 paquetes en diferentes momentos

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                   TIMELINE                                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                               โ
โ  DรA 1: Se abre Paquete A                                   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                 โ
โ  โ Bulk Conversion #1                     โ                 โ
โ  โ Fecha: 2025-10-01                      โ                 โ
โ  โ Cantidad: 500g                         โ                 โ
โ  โ Restante: 500g                         โ                 โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                 โ
โ                                                               โ
โ  DรA 3: Se abre Paquete B                                   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                 โ
โ  โ Bulk Conversion #2                     โ                 โ
โ  โ Fecha: 2025-10-03                      โ                 โ
โ  โ Cantidad: 500g                         โ                 โ
โ  โ Restante: 500g                         โ                 โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                 โ
โ                                                               โ
โ  DรA 5: Se abre Paquete C                                   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                 โ
โ  โ Bulk Conversion #3                     โ                 โ
โ  โ Fecha: 2025-10-05                      โ                 โ
โ  โ Cantidad: 500g                         โ                 โ
โ  โ Restante: 500g                         โ                 โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                 โ
โ                                                               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

Cliente quiere comprar 800g a granel

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ              SISTEMA APLICA FIFO                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                               โ
โ  1. Toma TODO del Bulk Conversion #1 (mรกs antiguo)          โ
โ     โ 500g del Paquete A                                     โ
โ     โ Restante: 0g (COMPLETED)                              โ
โ                                                               โ
โ  2. Necesita 300g mรกs (800 - 500 = 300)                     โ
โ     Toma del Bulk Conversion #2 (siguiente mรกs antiguo)     โ
โ     โ 300g del Paquete B                                     โ
โ     โ Restante: 200g (ACTIVE)                               โ
โ                                                               โ
โ  3. No toca el Bulk Conversion #3                           โ
โ     โ 500g del Paquete C                                     โ
โ     โ Restante: 500g (ACTIVE)                               โ
โ                                                               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

Resultado Final:
  โ Cliente recibe 800g
  โ Se usรณ primero el paquete mรกs antiguo (FIFO)
  โ Stock a granel actualizado automรกticamente
```

---

## ๐ฑ Interfaz de Usuario - Wireframe

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  MAPO - Gestiรณn de Inventario                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ Producto: Arroz Diana                              โ   โ
โ  โ Presentaciรณn: Paquete x 500g                       โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค   โ
โ  โ                                                     โ   โ
โ  โ  ๐ฆ Stock Empaquetado:   9 paquetes               โ   โ
โ  โ  ๐พ Stock a Granel:      500g disponibles         โ   โ
โ  โ                                                     โ   โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ     โ   โ
โ  โ  โ  [๐ฆโก๏ธ๐พ Abrir para Granel]              โ     โ   โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ     โ   โ
โ  โ                                                     โ   โ
โ  โ  Historial de Conversiones:                       โ   โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ      โ   โ
โ  โ  โ 2025-10-13 10:30                        โ      โ   โ
โ  โ  โ Abierto: 500g | Vendido: 150g          โ      โ   โ
โ  โ  โ Disponible: 350g                        โ      โ   โ
โ  โ  โ Estado: ๐ข ACTIVO                       โ      โ   โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ      โ   โ
โ  โ                                                     โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ฏ Casos de Uso Visualizados

### Caso 1: Cliente quiere 300g pero solo hay paquetes de 500g

```
ANTES:
โโโโโโโโโโโโโโโโโโโโโโโ
โ Stock: 10 paquetes  โ
โ No venta a granel   โ
โ โ No puede vender  โ
โ    300g             โ
โโโโโโโโโโโโโโโโโโโโโโโ

Usuario abre 1 bulto
         โ

DESPUรS:
โโโโโโโโโโโโโโโโโโโโโโโ
โ Stock: 9 paquetes   โ
โ Granel: 500g        โ
โ โ Puede vender     โ
โ    300g (sobran 200)โ
โโโโโโโโโโโโโโโโโโโโโโโ
```

### Caso 2: Optimizar stock prรณximo a vencer

```
Tienes 2 paquetes que vencen en 3 dรญas

ESTRATEGIA:
1. Abrir ambos paquetes (1000g total)
2. Ofrecer descuento por granel
3. Vender rรกpido antes del vencimiento

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ๐ฆ๐ฆ โ ๐พ๐พ (1000g)              โ
โ                                  โ
โ Descuento: 10% por granel        โ
โ Resultado: Vendido en 2 dรญas     โ
โ โ Evita desperdicio             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

**Guรญa visual completa! ๐จ**

Ver documentaciรณn tรฉcnica en: `docs/BULK_CONVERSION_GUIDE.md`
